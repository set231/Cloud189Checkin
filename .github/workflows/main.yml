name: Sync Fork - Every 4 Hours

on:
  schedule:
    # æ¯4å°æ—¶åŒæ­¥ä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    # æ ¼å¼ï¼šåˆ†é’Ÿ(0-59) å°æ—¶(0-23) æ—¥(1-31) æœˆ(1-12) æ˜ŸæœŸ(0-6)
    - cron: '0 */4 * * *'  # æ¯4å°æ—¶çš„0åˆ†é’Ÿæ‰§è¡Œ
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "GitHub Sync Bot"
          git config user.email "actions@github.com"
          git config pull.rebase false

      - name: Add Upstream Remote
        run: |
          git remote add upstream https://github.com/[UPSTREAM_OWNER]/[UPSTREAM_REPO].git
          git fetch upstream
          
      - name: Check for Updates
        id: check
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æäº¤
          if git log --oneline HEAD..upstream/main | grep -q .; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "æœ‰æ–°æäº¤éœ€è¦åŒæ­¥"
            git log --oneline HEAD..upstream/main
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
          fi

      - name: Merge Updates (No Conflicts)
        if: steps.check.outputs.has_updates == 'true'
        id: merge
        run: |
          # å°è¯•å¿«è¿›åˆå¹¶
          if git merge --ff-only upstream/main; then
            echo "status=fast_forward" >> $GITHUB_OUTPUT
          else
            # å°è¯•æ™®é€šåˆå¹¶
            if git merge upstream/main --no-edit; then
              echo "status=merged" >> $GITHUB_OUTPUT
            else
              echo "æ£€æµ‹åˆ°å†²çª"
              # ä½¿ç”¨ç­–ç•¥ï¼šä¼˜å…ˆä¸Šæ¸¸ç‰ˆæœ¬
              git checkout --theirs . 2>/dev/null || true
              git add .
              git commit -m "chore: merge upstream (resolve conflicts)" || echo "æäº¤å¯èƒ½å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
              echo "status=conflict_resolved" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Push Changes
        if: steps.check.outputs.has_updates == 'true' && steps.merge.outputs.status
        run: |
          git push origin main

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            await github.rest.issues.create({
              owner,
              repo,
              title: 'ğŸš¨ è‡ªåŠ¨åŒæ­¥å¤±è´¥',
              body: `åŒæ­¥ä¸Šæ¸¸ä»“åº“æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ã€‚\n\nå·¥ä½œæµè¿è¡Œï¼š${context.runId}`,
              labels: ['automation', 'sync-failed']
            });
